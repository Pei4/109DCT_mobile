<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name=”viewport” content=”width=device-width,initial-scale=0">
    <title>lv3</title>
    <link rel=stylesheet type="text/css" href="../reset.css">
    <link rel="stylesheet" type="text/css" href="../scss/lv3_2.css">
    <link rel="stylesheet" type="text/css" href="../scss/mobile.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../js/lv3_2.js" crossorigin="anonymous"></script>
    <script src="../js/functions.js"></script>
    <script src="../js/html2canvas.js"></script>
</head>
<body>
<a>拖曳小星球於喜歡的合照位置</a>
<img id="flipBtn" src="../material/flip.png">
<div id="takePhoto"> <!--拍照有關的功能-->
    <video id="view" autoplay loop playsinline></video>
    <div id="capture"> <!--要存檔的東西放這邊-->
        <canvas id="shotCanvas" class="before"></canvas>
        <img id="planet0" ontouchstart="down()" ontouchmove="over(event)" ontouchend="up()" src="">
        <img id="prepare">
    </div>
    <img id="shotBtn" src="../material/shot.png" onclick="screenShot()">
    <button id="revBtn" class="opt" onclick="reverse()" style="display: none">重拍</button>
    <button id="goDownloadBtn" class="opt" onclick="goDownload()" style="display: none">下載</button>
    <a id="downA" href="#" style="display: none"></a>
</div>
<div id="photoMask" style="display: none">
    <img id="back" src="../material/back.png" onclick="back()">
    <img id="photo2">
    <a>iOS 請長按圖片後儲存</a>
</div>
<div id="screen"><br><br><br><br><br><br>請使用行動裝置，以獲取最佳遊戲體驗 :)</div>
</body>
</html>
<script>
    let vid = document.querySelector('#view');
    let canvas = document.querySelector('#shotCanvas')
    let context = canvas.getContext('2d');
    let capture = document.getElementById('capture');
    let downloadImg = document.getElementById('prepare');
    let p2 = document.getElementById('photo2');
    let a = document.getElementById('downA');
    let w, h, ratio;
    let imgURL;
    let face = 1;

    function runVid(){
        document.getElementById('planet0').src = `../material/p_A12.png`; //${resStr}
        constraints = {video: {facingMode: 'user'}};
        //存取相機
        function handleSuccess(stream) {
            window.stream = stream;
            vid.srcObject = stream;
        }
        function handleError(error) {
            console.log('getUserMedia error: ', error);
        }
        document.getElementById('flipBtn').addEventListener('click',(constraints)=>{
            if (face == 1){
                console.log('toEnv');
                face --;
                window.stream.stop();
                vid.srcObject = null;
                constraints = {video:{facingMode: 'environment'}};
                setTimeout(()=>{
                    window.stream = stream;
                    vid.srcObject = stream;
                },100);
            }
            else {
                console.log('toUser');
                face ++;
                window.stream.stop();
                vid.srcObject = null;
                constraints = {video:{facingMode: 'user'}};
                setTimeout(()=>{
                    window.stream = stream;
                    vid.srcObject = stream;
                },100);
            }
        })
        navigator.mediaDevices.getUserMedia(constraints)
            .then(handleSuccess)
            .catch(handleError)
    }
    vid.addEventListener('loadedmetadata', function() {
        ratio = vid.videoWidth / vid.videoHeight;
        w = vid.videoWidth - 100;
        h = parseInt(w/ratio, 10);
        canvas.width = w;
        canvas.height = h;
        downloadImg.style.height = `${parseInt(100/ratio, 10)}vw`;
        p2.style.height = `${parseInt(100/ratio, 10)}vw`;
    }, false);

    function screenShot(){
        addClass('shotCanvas','after');
        addClass('prepare','after');
        hideSth('view');
        hideSth('shotBtn');
        showSth('goDownloadBtn');
        showSth('revBtn');
        context.fillRect(0, 0, w, h);
        context.drawImage(vid, 0, 0, w, h);
        html2canvas(document.getElementById('capture')).then(function(canvas) {
            imgURL = canvas.toDataURL("image/png");
            downloadImg.setAttribute('src', imgURL);
            document.getElementById('photo2').src = imgURL;
        });
    }
    function goDownload(){
        if(iosList.includes(navigator.platform)==true|| (navigator.userAgent.includes("Mac") && "ontouchend" in document)==true){
            showSth('photoMask');
        }
        else {
            a.setAttribute('href',imgURL);
            a.setAttribute('download','our_picture');
            a.click();
        }
    }
    function reverse(){
        addClass('shotCanvas','before');
        addClass('prepare','before');
        showSth('view');
        showSth('shotBtn');
        hideSth('revBtn');
        hideSth('goDownloadBtn');
    }
</script>