<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name=”viewport” content=”width=device-width,initial-scale=0">
    <title>lv3</title>
    <link rel=stylesheet type="text/css" href="../reset.css">
    <link rel="stylesheet" type="text/css" href="../scss/lv3_2.css">
    <link rel="stylesheet" type="text/css" href="../scss/mobile.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../js/lv3_2.js" crossorigin="anonymous"></script>
    <script src="../js/functions.js"></script>
    <script src="../js/html2canvas.js"></script>
</head>
<body>
<a>拖曳小星球於喜歡的合照位置</a>
<div id="takePhoto"> <!--拍照有關的功能-->
    <video id="view" autoplay loop playsinline></video>
    <div id="capture"> <!--要存檔的東西放這邊-->
        <canvas id="shotCanvas" class="before"></canvas>
        <img id="planet0" ontouchstart="down()" ontouchmove="over(event)" ontouchend="up()" src="">
        <img id="prepare">
    </div>
    <button id="shot" class="opt" onclick="screenShot()">拍照</button>
    <button id="rev" class="opt" onclick="reverse()">重拍</button>
    <button id="goDownloadBtn" class="opt" onclick="goDownload()">下載</button>
    <a id="down_qr" href="#" style="display: none"></a>
</div>
<div id="screen"><br><br><br><br><br><br>請使用行動裝置，以獲取最佳遊戲體驗 :)</div>
</body>
</html>
<script>
    let vid = document.querySelector('#view');
    let canvas = document.querySelector('#shotCanvas')
    let context = canvas.getContext('2d');
    let capture = document.getElementById('capture');
    let downloadImg = document.getElementById('prepare');
    let w, h, ratio;
    let imgURL;

    function runVid(){
        document.getElementById('planet0').src = `../material/p_A12.png`; //${resStr}
        let constraints = {video: {facingMode: { exact: "user" }}};
        //存取相機
        function handleSuccess(stream) {
            window.stream = stream;
            vid.srcObject = stream;
        }
        function handleError(error) {
            console.log('getUserMedia error: ', error);
        }
        navigator.mediaDevices.getUserMedia(constraints)
            .then(handleSuccess)
            .catch(handleError)
    }
    vid.addEventListener('loadedmetadata', function() {
        ratio = vid.videoWidth / vid.videoHeight;
        w = vid.videoWidth - 100;
        h = parseInt(w/ratio, 10);
        canvas.width = w;
        canvas.height = h;
        downloadImg.style.height = `${parseInt(100/ratio, 10)}vw`;
    }, false);

    function screenShot(){
        addClass('shotCanvas','after');
        addClass('prepare','after');
        hideSth('view');
        context.fillRect(0, 0, w, h);
        context.drawImage(vid, 0, 0, w, h);
        let dataURL = canvas.toDataURL('image/png');
        downloadImg.setAttribute('src', dataURL);
        html2canvas(document.getElementById('capture')).then(function(canvas) {
            imgURL = canvas.toDataURL("image/png");
            downloadImg.setAttribute('src', imgURL);
        });
    }
    function goDownload(){
        html2canvas(document.getElementById('capture')).then(function(canvas) {
            if(iosList.includes(navigator.platform)==true|| (navigator.userAgent.includes("Mac") && "ontouchend" in document)==true){
                imgURL = imgURL.replace("image/png", "image/octet-stream");
                //window.open(imgURL);
                let w = window.open("");
                w.document.write(downloadImg.outerHTML);
            }
            else {
                $('#down_qr').attr('download','our_picture');
                $('#down_qr').attr('href',imgURL);
                document.getElementById('down_qr').click();
            }
        });
    }
    function reverse(){
        addClass('shotCanvas','before');
        addClass('prepare','before');
        showSth('view');
    }
</script>